= Booting a LiveCD =

This guide describes how to boot a Linux LiveCD directly from the AppleTV. It requires;
 # An working Linux computer capable of telnet
 # A network with a DHCP server (router, etc)
 # AppleTV (of course).
 # A wired network connection to the AppleTV.
 # A USB Hub (a powered USB hub is preferable but not required).
 # A USB cdrom drive.
 # A USB mouse.
 # A USB keyboard.
 # An exiting LiveCD.
 # An existing USB flash drive with atv-bootloader installed.

= Ubuntu 7.10 Gutsy =
Let's get started. For this example, we are going to manually boot Ubuntu 7.10 Gutsy LiveCD using atv-bootloader. 

On a working Linux system, create a USB flash drive with atv-bootloader installed. You will need to first extract "boot.efi" and build and install parted and hfstools. See [BootEFIExtraction extract boot.efi] for boot.efi, [InstallParted install parted] for parted and [InstallHFSTools install hfs tools] for hfs support].
 

Remember to *[ATVBackup backup the internal PATA "Recovery" partiton]* if you are going to over-write the internal PATA disk. You can use the same USB flash drive for this guide and skip the next section.

Once these tools are installed then create just the recovery partition on a USB pen drive, this does not require very much space so 64MB or greater pen drive is fine. This guide will assume the device at "/dev/sdb" is the pen drive so remember to adjust this to match your setup. If you have problems partitioning, you might have a [FixingUSBFlashDrives USB flash drive that needs fixing].
{{{
# zero the initial sectors
sudo dd if=/dev/zero of=/dev/sdb bs=4096 count=1M

# create the GPT format
sudo parted -s /dev/sdb mklabel gpt

# create just a recovery partition
sudo parted -s /dev/sdb mkpart primary HFS 40s 69671s
sudo parted -s /dev/sdb set 1 atvrecv on

# update the system partition tables
sudo partprobe /dev/sdb

# format it
sudo mkfs.hfsplus -v Recovery /dev/sdb1

# mount it
mkdir penboot
sudo mount /dev/sdb1 penboot

# download atv-bootloader (recovery.tar.gz) and install it
wget http://atv-bootloader.googlecode.com/files/recovery-0.6.tar.gz
sudo tar -xzf recovery-0.6.tar.gz
sudo cp -arp recovery/* penboot/
# remember to copy boot.efi too
sudo cp -ap boot.efi penboot/

# unmount and cleanup
umount penboot
rmdir penboot
}}}

The current version of atv-bootloader will enable telnetd and drop to a login prompt if it does not find any valid boot configs. Power-on the AppleTV with the USB flash drive inserted, you might have to hold "menu" and '-' buttons down on the Apple IR remote to force USB probe and boot.

You should see the atv-bootloader logo (tux on the AppleTV), then kernel boot console messages (tux in the upper left corner), then a "penbuntu" login prompt. It's easer to do everything from a telnet session so telnet in using the IP address that is reported by atv-bootloader. Username is "root", password is "root".

Power-up the USB cdrom and insert your LiveCD. Wait until the cdrom spins up, then via a telnet session;
{{{
mkdir /cdrom
mount -o loop /dev/sr0 /cdrom
}}}

Find "isolinux.cfg" boot.conf. This is either at the root level of the cdrom or in a "boot" or "isolinux" directory. For Ubuntu 7.10 Gutsy the path is "/cdrom/isolinux/isolinux.cfg". Dump this file and locate the default boot setting", for Gutsy it looks like this;
{{{
DEFAULT /casper/vmlinuz
GFXBOOT bootlogo
GFXBOOT-BACKGROUND 0xB6875A
APPEND  file=/cdrom/preseed/ubuntu.seed boot=casper initrd=/casper/initrd.gz quiet splash --
}}}

Now we manually convert isolinux params into kexec params. See this link for more information about [Understandingkexec understanding kexec params].  An important note, the AppleTV does not have a PC BIOS so video console mode changes will not work. With atv-bootlaoder, a "vesafb" will work as a console framebuffer and you should see the kernel boot messages. However, Ubuntu does not include "vesafb" in their initramfs so we will not see kernel boot messages. In addition we need to add "vesa" and change "splash" to "nosplash" to get X11 to come up, here are the resulting kexec params.
{{{
kexec --load /cdrom/casper/vmlinuz \
--initrd=/cdrom/casper/initrd.gz \
--command-line="file=/cdrom/preseed/ubuntu.seed boot=casper initrd=/casper/initrd.gz nosplash vesa" 
}}}

Doing the above, on the command-line results in the kexec load printing the following information. This means, kexec has loaded the kernel/initrd and params into RAM and has set flags that a kexec jump is pending. "1280x720x32" is the video resolution as passed by the AppleTV EFI firmware, 10028000 is the video base address.
{{{
setup_linux_vesafb: 1280x720x32 @ 10028000 +708000
}}}

Now do the kexec jump
{{{
kexec -e
}}}

You should hear the cdrom spin up and start making disk access noises. With Gutsy, since the console framebuffer does not work, the display will look frozen. Wait until X11 starts. Then the display will change and if you are lucky, it will be perfect. Gusty is not so lucky as there seems to be some bug in X11 does not setup the initial video properly. What I see is a horizontal repeating desktop (four repeats). All is not lost, if you move the mouse around, you will notice that the mouse/cursor coordinates are correct. So move the cursor to the upper left, mouse down and move right slowly. The menu in the menubar will drop down. Go to System -> Administration -> Screens and Graphics. Select a resolution supported by your display. I picked 1280 x 720 to match the AppleTV EFI firmware setting. Click "OK" not "Test" and the display should change resolution and life is now good.

It takes a little practice to get the cursor in the correct place, think a little horizontal offset and watch the control/button highlighting. The control/button will highlight when the cursor is over top.

The other way is to open a terminal "Applications -> Accessories -> Terminal". The type "sudo displayconfig-gtk" and this will open the GUI display settings window.

If you have pre-formatted the install disk, proceed to installing your distro. If not then you can build/install the required tools from the LiveCD. [PartitioningLinux See this section for information].

Other LiveCD distributions will be similar steps. Extract the default ioslinux settings. Translate to kexec params. Turn off "splash", set "vga=normal" and try adding "video=vesafb". Then see what happens.

= Mythbuntu =
Here's an example for Mythbuntu, the default isolinux setting is
{{{
DEFAULT /casper/vmlinuz
GFXBOOT bootlogo
APPEND  boot=casper initrd=/casper/initrd.gz quiet splash --
}}}

The translated kexec params for cdrom boot are
{{{
kexec --load /cdrom/casper/vmlinuz \
--initrd=/cdrom/casper/initrd.gz \
--command-line="boot=casper initrd=/casper/initrd.gz nosplash vesa" 
}}}

Mythbuntu uses GRUB so atv-bootloader will be able to automatically find and translate GRUB's menu.lst boot settings.

= !KnoppMyth =

Here's an example for !KnoppMyth, the default isolinux setting is
{{{
DEFAULT linux
APPEND ramdisk_size=100000 init=/etc/init lang=us vga=791 initrd=minirt.gz nomce
}}}

The translated kexec params for cdrom boot are
{{{
kexec --load /cdrom/boot/isolinux/linux \
--initrd=/cdrom/boot/isolinux/minirt.gz \
--command-line="ramdisk_size=100000 init=/etc/init lang=us vga=normal initrd=minirt.gz nomce" 
}}}

And the LILO translated kexec params for disk boot are ("/dev/sda1" is mounted at "/root/tmp")
{{{
kexec --load /root/tmp/boot/vmlinuz-2.6.18-chw-13 \
--initrd=/root/tmp/boot/initrd.gz \
--command-line="root=/dev/hda1 lang=us nomce vga=normal initrd=initrd.gz"
}}}

= !MythDora 5 =

*under construction* -- LiveCD boot works, installed boot using kexec is failing.

Here's an example for !MythDora 5, the default isolinux setting is
{{{
label linux
  menu label ^Install or upgrade an existing system
  menu default
  kernel vmlinuz            
  append initrd=initrd.img noselinux selinux=off
}}}

The translated kexec params for cdrom boot are
{{{
kexec --load /cdrom/isolinux/vmlinuz \
--initrd=/cdrom/isolinux/initrd.img \
--command-line="initrd=initrd.img noselinux selinux=off video=vesafb xdriver=vesa" 
}}}

!MythDora uses GRUB so atv-bootloader will be able to automatically find and translate GRUB's menu.lst boot settings.
