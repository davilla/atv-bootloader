= Instructions for creating and formating proper AppleTV partitions=

== Introduction ==

All Intel Apple computers (including the AppleTV) use GPT as a partition format. The internal disk inside the AppleTV has four partitions. If you want to know more about GPT and GUIDs see [http://en.wikipedia.org/wiki/GUID_Partition_Table]

The first partition is labeled "EFI" and is FAT32 but it has a special GUID. This partition is typically empty and only used for RAID drives on OS X desktop or server computers. The AppleTV disk does not really need this partition but I always include it on internal hard drives because you never know.

The second partition is labeled "Recovery". It's a HFS-plus format but it also has a special GUID. The AppleTV keeps a disk image (dmg) of the OSBoot files. It's called Recovery because the AppleTV firmware can restore the next partition (OSBoot) in case it detects problems. When you select "restore" from the configure menu, this is where the AppleTV pulls an OS image.

The third partition is labeled "OSBoot". It's also a HFS-plus format and has the normal GUID for HFS-plus. This holds the normally booted AppleTV OS (which is a derivative of OS X 10.4.x) and FrontRow.

The fourth partition is labeled "Media". It's also HFS-plus and it only holds media content. This partition can be reduced in size if you want to create more partitions for linux usage.

The AppleTV firmware boots by looking for a file called boot.efi on OSBoot. Boot.efi loads a darwin mach kernel (called mach_kernel) and drivers (kext). If it can't find boot.efi, it then looks for boot.efi on Recovery. We boot Linux by taking advantage of the recovery mode of the firmware. When the AppleTV OS boots, it resets an internal boot attempt count. If the boot attempt count goes to zero, the firmware will look over the USB bus for a Mass Storage Device with a Recovery partition and attempt boot. You can also force the USB probe by holding down the "menu" and "-" buttons on the IR remote at powerup.

So to get Linux to boot, we create a proper Recovery partition with boot.efi and a mach kernel that is actually a secondary Linux boot loader. The firmware loads boot.efi which loads our "mach kernel" and a dummy kext, at that point we have control and own the box.

Creating the proper disk format and partitions is critical for booting Linux on the AppleTV. The disk is gpt formated and must have the proper GUID associated with specific partitions or the AppleTV will refuse to boot. These instructions detail how to properly create and format the required gpt partitions using a [http://www.mythbuntu.org/ MythBuntu] LiveCD running on normal PC hardware. Booting the LiveCD on the AppleTV is not possible at the current time.

== Details ==

* boot the LiveCD and enable sshd
{{{
# boot the LiveCD and open a terminal
# start sshd for remote terminal access
sudo /etc/init.d/ssh start

# change the password for the ubuntu user so we can ssh in
passwd
current (just hit enter)
new let5me6in
again let5me6in
}}}

* from a terminal on a working linux system (or the above LiveCD terminal)
{{{
# now we can ssh in from another box (skip this is using the LiveCD terminal)
# you will need to replace the below IP address with that of your system
# I like to do it this way so I can copy/paste rather than type exact commands
ssh ubuntu@192.168.2.67
password -> let5me6in
}}}

* install build tools
{{{
# mythbuntu has a problem with PATH so we need to reference the full path for apt-get
sudo /usr/bin/apt-get install build-essential
}}}

* build and install the patched parted
{{{
# remove the existing parted 
sudo /usr/bin/apt-get remove parted

# fetch the patched parted
wget http://atv-bootloader.googlecode.com/files/parted-1.8.8-atv.tar.gz
tar -xzf parted-1.8.8-atv.tar.gz

# build and install the patched parted
cd parted
sudo ./install_parted.sh
sudo ln -s /usr/local/sbin/parted /sbin/parted

# verify the install
parted --version
# you should see "parted (GNU parted) 1.8.8"
}}}

* build and install hfs support tools
{{{
# fetch hfs_support
wget http://atv-bootloader.googlecode.com/files/hfs_support-1.0.tar.gz
tar -xzf hfs_support-1.0.tar.gz

# build and install
cd hfs_support/
sudo ./build_diskdev_cmds.sh
}}}

* create and format an AppleTV compatible disk
{{{
# ** warning
# ** you must be careful of the target disk/partition
# ** the below assumes LiveCD boot and USB disk at sda
# ** warning
# 
# zero /dev/sda first or pre-existing guid will not change
dd if=/dev/zero of=/dev/sda bs=4096 count=1M

# create initial gpt structures
sudo parted -s /dev/sda mklabel gpt

# find max size of disk (see Disk  /dev/sda: XXXMB from listing)
sudo parted /dev/sda
print
quit

# mine reports "Disk /dev/sda: 20.0GB" so that is our ending point

# create a 25MB "EFI" partition (starting at sector 40 is important)
sudo parted -s /dev/sda mkpart primary fat32 40s 25M
sudo parted -s /dev/sda set 1 boot on

# create a 25MB "Recovery" partition
sudo parted -s /dev/sda mkpart primary HFS 25M 50M
sudo parted -s /dev/sda set 2 atvrecv on

# create a 25MB "OSBoot" partition
sudo parted -s /dev/sda mkpart primary HFS 50M 75M

#create the linux root partition
sudo parted -s /dev/sda mkpart primary ext2 75M 18.9GB

#create the linux swap partition
sudo parted -s /dev/sda mkpart primary linux-swap 18.9GB 20.0GB


# verify the partitions
sudo parted /dev/sda
print

# you should see something similar (note boot and atvrecv flags)
Model: IC25N020 ATDA04-0 (scsi)
Disk /dev/sda: 20.0GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt

Number  Start   End     Size    File system  Name     Flags  
 1      20.5kB  25.0MB  25.0MB               primary  boot   
 2      25.0MB  50.0MB  25.0MB               primary  atvrecv
 3      50.0MB  75.0MB  25.0MB               primary         
 4      75.0MB  18.9GB  18.8GB               primary         
 5      18.9GB  20.0GB  1104MB               primary         


# format the partitions
sudo mkfs.msdos -F 32 -n EFI /dev/sda1
sudo mkfs.hfsplus -v Recovery /dev/sda2
sudo mkfs.hfsplus -v OSBoot /dev/sda3
sudo mkfs.ext3  -b 4096 -L mythbuntu /dev/sda4
we will let the LiveCD setup swap
sync 
}}}

* install atv-bootloader
{{{
remove/reinsert USB plug, the LiveCD should auto-mount
at /media/Recovery, /media/OSBoot and /media/mythbuntu
}}}

{{{
# pulling from svn
sudo /usr/bin/apt-get install subversion
svn checkout http://atv-bootloader.googlecode.com/svn/trunk/ atv-bootloader-read-only
cd atv-bootloader-read-only

# or just download
wget http://atv-bootloader.googlecode.com/files/recovery-0.4.tar.gz

tar -xzf recovery.tar.gz
sudo cp -arp recovery/* /media/OSBoot/
sudo cp -arp recovery/* /media/Recovery/
# remember to copy boot.efi too
sudo cp -ap boot.efi /media/OSBoot
sudo cp -ap boot.efi /media/Recovery
}}}

* now proceed to install your linux distro
{{{
remember to install to /dev/sda4 with swap at /dev/sda5

it is ok to install grub, in fact you will need the menu.lst that grub creates,
however the MBR that grub installs needs to be over-written to enable
fast boots to the tux/atv logo. This can be done after your linux install is running
and is outlined in the installing MythBuntu page.
}}}